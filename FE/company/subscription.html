<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription - SkillRank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="bg-slate-50 text-slate-900">
    <nav id="navbar" class="fixed w-full z-50 glass-effect border-b border-slate-200"></nav>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
        <h1 class="text-3xl font-bold mb-8">Subscription Management</h1>

        <!-- Current Plan -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8" id="current-plan">
            <div class="text-center py-4"><div class="spinner mx-auto"></div></div>
        </div>

        <!-- Plans -->
        <h2 class="text-xl font-bold mb-4">Available Plans</h2>
        <div class="grid md:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl p-6 border border-slate-200 card-hover" id="plan-basic">
                <div class="text-center mb-4">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">Basic</span>
                    <div class="mt-3 text-3xl font-bold">Free</div>
                </div>
                <ul class="space-y-2 mb-6 text-sm">
                    <li>2 tasks/month</li>
                    <li>View submissions</li>
                    <li>Score & evaluate</li>
                </ul>
                <button onclick="upgradePlan('basic')" data-plan="basic" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 rounded-xl font-semibold transition plan-btn">Select</button>
            </div>
            <div class="bg-white rounded-xl p-6 border-2 border-blue-500 card-hover" id="plan-standard">
                <div class="text-center mb-4">
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold">Standard</span>
                    <div class="mt-3 text-3xl font-bold">$49.99/mo</div>
                </div>
                <ul class="space-y-2 mb-6 text-sm">
                    <li>5 tasks/month</li>
                    <li>Task leaderboard</li>
                    <li>Rank applicants</li>
                </ul>
                <button onclick="upgradePlan('standard')" data-plan="standard" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl font-semibold transition plan-btn">Upgrade</button>
            </div>
            <div class="bg-white rounded-xl p-6 border border-slate-200 card-hover" id="plan-premium">
                <div class="text-center mb-4">
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold">Premium</span>
                    <div class="mt-3 text-3xl font-bold">$99.99/mo</div>
                </div>
                <ul class="space-y-2 mb-6 text-sm">
                    <li>Unlimited tasks</li>
                    <li>Global leaderboard</li>
                    <li>CSV export</li>
                    <li>Advanced filters</li>
                </ul>
                <button onclick="upgradePlan('premium')" data-plan="premium" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2.5 rounded-xl font-semibold transition plan-btn">Upgrade</button>
            </div>
        </div>
    </div>

    <!-- QR Payment Modal -->
    <div id="qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 p-8 text-center relative">
            <button onclick="closeQrModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            <h3 class="text-xl font-bold mb-2">Thanh toán chuyển khoản</h3>
            <p class="text-slate-500 mb-1">Gói: <span id="qr-plan-name" class="font-semibold text-blue-600 capitalize"></span></p>
            <p class="text-slate-500 mb-4">Giá: <span id="qr-plan-price" class="font-semibold text-slate-800"></span></p>
            <img src="/assets/image/image.png" alt="QR Code chuyển khoản" class="mx-auto rounded-xl border border-slate-200 max-w-[280px] w-full mb-4">
            <p class="text-sm text-slate-500 mb-6">Quét mã QR để chuyển khoản. Sau khi chuyển khoản thành công, bấm xác nhận bên dưới.</p>
            <div class="flex gap-3">
                <button onclick="closeQrModal()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 rounded-xl font-semibold transition">Hủy</button>
                <button onclick="confirmPayment()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl font-semibold transition">Xác nhận đã thanh toán</button>
            </div>
        </div>
    </div>

    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/navbar.js"></script>
    <script src="/assets/js/utils.js"></script>
    <script>
        if (!requireAuth('company')) throw new Error('Not authorized');

        async function loadCurrentPlan() {
            try {
                const data = await apiGet('/subscription/current');
                document.getElementById('current-plan').innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold mb-1">Current Plan: <span class="capitalize text-blue-600">${data.subscription_plan}</span></h2>
                            <div class="text-slate-500 text-sm">Task usage: ${data.tasks_used} / ${data.task_limit}</div>
                            ${data.subscription_expiry ? `<div class="text-slate-500 text-sm">Expires: ${formatDate(data.subscription_expiry)}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">${data.tasks_used}<span class="text-slate-400 text-lg">/${data.task_limit}</span></div>
                            <div class="text-sm text-slate-500">Tasks Used</div>
                        </div>
                    </div>
                    <div class="mt-4 score-bar w-full">
                        <div class="score-bar-fill" style="width:${Math.min((data.tasks_used / data.task_limit) * 100, 100)}%"></div>
                    </div>
                `;

                // Highlight current plan
                document.querySelectorAll('.plan-btn').forEach(btn => {
                    if (btn.dataset.plan === data.subscription_plan) {
                        btn.textContent = 'Current Plan';
                        btn.disabled = true;
                        btn.className = 'w-full bg-slate-200 text-slate-500 py-2.5 rounded-xl font-semibold cursor-not-allowed plan-btn';
                    }
                });
            } catch (err) {
                document.getElementById('current-plan').innerHTML = '<div class="text-center text-red-500">Failed to load subscription info</div>';
            }
        }

        const planPrices = { basic: 'Miễn phí', standard: '$49.99/tháng', premium: '$99.99/tháng' };
        let selectedPlan = null;

        function upgradePlan(plan) {
            selectedPlan = plan;
            document.getElementById('qr-plan-name').textContent = plan;
            document.getElementById('qr-plan-price').textContent = planPrices[plan] || plan;
            const modal = document.getElementById('qr-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeQrModal() {
            const modal = document.getElementById('qr-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            selectedPlan = null;
        }

        async function confirmPayment() {
            if (!selectedPlan) return;
            try {
                await apiPut('/subscription/upgrade', { plan: selectedPlan });
                showToast('Yêu cầu nâng cấp đã được gửi! Vui lòng chờ admin xác nhận thanh toán.', 'success');
                closeQrModal();
            } catch (err) {
                showToast(err.message || 'Gửi yêu cầu thất bại', 'error');
            }
        }

        // Close modal on backdrop click
        document.getElementById('qr-modal').addEventListener('click', function(e) {
            if (e.target === this) closeQrModal();
        });

        loadCurrentPlan();
    </script>
</body>
</html>
